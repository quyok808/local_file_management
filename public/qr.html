<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg stroke='currentColor' fill='none' stroke-width='1.5' viewBox='0 0 24 24' aria-hidden='true' height='200px' width='200px' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' d='M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z'></path><path stroke-linecap='round' stroke-linejoin='round' d='M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z'></path></svg>"
    />
    <title>Quản lý mã QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }

      input {
        margin: 5px;
        padding: 6px 10px;
      }

      #list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .qr-card {
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 15px;
        text-align: center;
        background: white;
      }

      .qr-card canvas {
        width: 100%;
        max-width: 220px;
        margin-bottom: 10px;
      }

      .qr-card input {
        width: 90%;
        padding: 6px;
        margin-bottom: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }

      .btn-delete {
        background: red;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 5px;
      }

      .btn-delete:hover {
        opacity: 0.8;
      }

      .status {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
      }

      #saveAllBtn,
      .addBtn {
        background: green;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-left: 10px;
      }

      #saveAllBtn:hover {
        opacity: 0.8;
      }
    </style>
  </head>

  <body>
    <h2>Quản lý mã QR</h2>

    <input id="inputText" placeholder="Nhập nội dung..." />
    <button class="addBtn" onclick="addQR()">Thêm QR</button>
    <button id="saveAllBtn" onclick="saveAll()">Lưu tất cả</button>

    <h3>Danh sách QR</h3>
    <div id="list"></div>

    <script>
      let items = [];

      async function loadData() {
        const res = await fetch("/api/qr");
        items = (await res.json()).map((i) => ({ ...i, saved: true }));
        render();
      }

      async function saveAll() {
        // Lấy danh sách cần lưu
        items.forEach((i) => (i.saved = true));
        await fetch("/api/qr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(items.map(({ saved, ...rest }) => rest)),
        });
        render();
      }

      function render() {
        const list = document.getElementById("list");
        list.innerHTML = "";

        items.forEach((item, index) => {
          const card = document.createElement("div");
          card.className = "qr-card";

          // Status
          const status = document.createElement("span");
          status.className = "status";
          status.innerText = item.saved ? "Đã lưu" : "Chưa lưu";
          status.style.color = item.saved ? "green" : "red";

          // QR Canvas
          const canvas = document.createElement("canvas");
          new QRious({ element: canvas, value: item.text, size: 240 });

          // Input text
          const input = document.createElement("input");
          input.type = "text";
          input.value = item.text;
          input.oninput = (e) => {
            item.text = e.target.value;
            item.saved = false;
            render();
          };

          // Delete button
          const del = document.createElement("button");
          del.className = "btn-delete";
          del.innerText = "Xóa";
          del.onclick = () => deleteQR(index);

          card.appendChild(status);
          card.appendChild(canvas);
          card.appendChild(input);
          card.appendChild(del);
          list.appendChild(card);
        });
      }

      async function addQR() {
        const text = document.getElementById("inputText").value.trim();
        if (!text) return alert("Nội dung không được để trống");

        items.push({
          id: Date.now(),
          text,
          saved: false,
        });

        render();
      }

      async function deleteQR(index) {
        items.splice(index, 1);
        await fetch("/api/qr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(items.map(({ saved, ...rest }) => rest)),
        });
        render();
      }

      loadData();
    </script>
  </body>
</html>
